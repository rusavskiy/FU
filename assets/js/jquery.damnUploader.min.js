(function(b){function q(b,f){b=parseInt(b);f=f||"";if(0==b||isNaN(b))return f;var a=String.fromCharCode(Math.floor(26*Math.random())+97);return f+a+q(--b)}function r(b){return b instanceof File||b instanceof Blob}var l=!1;window.XMLHttpRequest&&(l=null!=(new XMLHttpRequest).upload);b.extend(b.support,{fileSelecting:null!=window.File&&null!=window.FileList,fileReading:null!=window.FileReader,fileSending:null!=window.FormData,uploadControl:l});b.fn.damnUploader=function(n,f){if(0==this.length)return this;
var a=this,g=a._damnUploaderQueue,e=a._damnUploaderSettings||{};if(!n||b.isPlainObject(n)){a._damnUploaderSettings=b.extend({url:"/upload.php",dataClient:"",multiple:!0,fieldName:"file",dropping:!0,dropBox:!1,limit:!1,limitAdditionComplete:!1,onSelect:!1,onAdditionComplete:!1,onLimitExceeded:!1,onAllComplete:!1},n||{});a._damnUploaderQueue={};a._damnUploaderItemsCount=0;g=a._damnUploaderQueue;e=a._damnUploaderSettings;a._damnUploaderFilesAddMap=function(k,c){var d=b.isFunction(c);if(!b.support.fileSelecting){if(a._damnUploaderItemsCount===
e.limit&&!e.multiple)return b.isFunction(e.onLimitExceeded)&&e.onLimitExceeded.call(a),e.limitAdditionComplete&&a._damnUploaderAdditionFilesComplete(k,e.onAdditionComplete),!1;var f={fake:!0,name:k.value,inputElement:k};if(d&&!c.call(a,f))return a._damnUploaderAdditionFilesComplete(k,e.onAdditionComplete),!0;a.damnUploader("addItem",f);a._damnUploaderAdditionFilesComplete(k,e.onAdditionComplete);return!0}k instanceof FileList&&b.each(k,function(f,h){if(1===f&&!e.multiple)return b.isFunction(e.onLimitExceeded)&&
e.onLimitExceeded.call(a),!1;if(a._damnUploaderItemsCount===e.limit)return b.isFunction(e.onLimitExceeded)&&e.onLimitExceeded.call(a),e.limitAdditionComplete&&a._damnUploaderAdditionFilesComplete(k,e.onAdditionComplete),!1;if(d&&!c.call(a,h))return a._damnUploaderAdditionFilesComplete(k,e.onAdditionComplete),!0;a.damnUploader("addItem",{file:h});a._damnUploaderAdditionFilesComplete(k,e.onAdditionComplete)});return!0};a._damnUploaderAdditionFilesComplete=function(e,c){if(b.isFunction(c)){if(!b.support.fileSelecting&&
!c.call(a))return!0;e instanceof FileList&&(e.length!==a._damnUploaderItemsCount&&1!==a._damnUploaderItemsCount||c.call(a))}return!0};a._damnUploaderUploadItem=function(a,c){if(!r(c.file))return!1;var d=new XMLHttpRequest,f=0,g=!1;d.upload?(d.upload.addEventListener("progress",function(a){a.lengthComputable&&(f=100*a.loaded/a.total,b.isFunction(c.onProgress)&&c.onProgress.call(c,Math.round(f)))},!1),d.upload.addEventListener("load",function(a){f=100;g=!0},!1)):g=!0;d.onreadystatechange=function(){var a=
b.isFunction(c.onComplete);4==this.readyState&&(c.cancelled=c.cancelled||!1,400>this.status?g?(b.isFunction(c.onProgress)&&c.onProgress.call(c,100),a&&c.onComplete.call(c,!0,this.responseText)):a&&c.onComplete.call(c,!1,null,0):a&&c.onComplete.call(c,!1,null,this.status))};var h=c.replaceName||c.file.name;d.open("POST",a);if(b.support.fileSending)h=new FormData,h.append("dataClient",e.dataClient),h.append(c.fieldName||"file",c.file),d.send(h);else if(b.support.fileReading&&d.sendAsBinary){d.setRequestHeader("Content-Type",
"multipart/form-data, boundary=xxxxxxxxx");d.setRequestHeader("Cache-Control","no-cache");var m="--xxxxxxxxx\r\n",h=unescape(encodeURIComponent(h)),m=m+("Content-Disposition: form-data; name='"+(c.fieldName||"file")+"'; filename='"+h+"'\r\n"),m=m+"Content-Type: application/octet-stream\r\n\r\n"+((c.file.getAsBinary?c.file.getAsBinary():c.file.readAsBinary())+"\r\n"),m=m+"--xxxxxxxxx--";d.sendAsBinary(m)}else d.setRequestHeader("Upload-Filename",c.file.name),d.setRequestHeader("Upload-Size",c.file.size),
d.setRequestHeader("Upload-Type",c.file.type),d.send(c.file);c.xhr=d};if("INPUT"==a.get(0).tagName&&"file"==this.attr("type")){var d=a.eq(0).attr("name");b.support.fileSelecting?e.multiple?a.attr("multiple",!0):a.attr("multiple",!1):("]"!=d.charAt(d.length-1)&&(d+="[]"),a.attr("name",d),a.attr("multiple",!1),d=a.parents("form").attr("action"),a._damnUploaderFakeForm=b("<form/>").attr({method:"post",enctype:"multipart/form-data",action:d}).hide().appendTo("body"));a._damnUploaderChangeCallback=function(){a._damnUploaderFilesAddMap(b.support.fileSelecting?
this.files:this,e.onSelect)};a.on({change:a._damnUploaderChangeCallback})}if(e.dropping&&(a.on({drop:function(b){a._damnUploaderFilesAddMap(b.originalEvent.dataTransfer.files,e.onSelect);return!1}}),e.dropBox))b(e.dropBox).on({drop:function(b){a._damnUploaderFilesAddMap(b.originalEvent.dataTransfer.files,e.onSelect);return!1}});return a}switch(n){case "addItem":if(!f)return!1;d=q(5);if(f.file.fake){var p=b(f.file.inputElement),l=b(p).clone();b(p).before(l);b(p).attr("id",d);b(p).appendTo(a._damnUploaderFakeForm);
l.on({change:a._damnUploaderChangeCallback});a._damnUploaderItemsCount++;return d}if(!r(f.file))return!1;g[d]=f;a._damnUploaderItemsCount++;return d;case "startUpload":if(!e.url)break;if(!b.support.fileSelecting){a._damnUploaderFakeForm.submit();break}b.each(g,function(d,c){var f=c.onComplete;c.fieldName=c.fieldName||e.fieldName;c.onComplete=function(c,l,h){this.cancelled||(delete g[d],a._damnUploaderItemsCount--);b.isFunction(f)&&f.call(this,c,l,h);0==a._damnUploaderItemsCount&&b.isFunction(e.onAllComplete)&&
e.onAllComplete.call(a,c,l)};a._damnUploaderUploadItem(e.url,c)});break;case "itemsCount":return a._damnUploaderItemsCount;case "cancelAll":if(!b.support.fileSelecting){a._damnUploaderItemsCount=0;a._damnUploaderFakeForm.empty();break}b.each(g,function(b,c){a.damnUploader("cancel",b)});break;case "cancel":d=f.toString();if(0<a._damnUploaderItemsCount){if(!b.support.fileSelecting){d=b("#"+d);0<d.length&&(d.remove(),a._damnUploaderItemsCount--);break}void 0!==g[d]&&(g[d].xhr&&(g[d].cancelled=!0,g[d].xhr.abort()),
delete g[d],a._damnUploaderItemsCount--)}break;case "setParam":var s=["url","multiple","fieldName","limit","dataClient"];b.each(f,function(d,c){b.inArray(d,s)&&(a._damnUploaderSettings[d]=c)})}return a}})(jQuery);
